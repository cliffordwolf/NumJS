<script type="text/javascript" src="../../NumJS.js"></script>
<script type="text/javascript">NumJS.loader_html("../../")</script>

<!-- duble buffering for textarea: this is a hack! some browsers reset the scrollbar to the top position whenever
writing to a textarea .value property. Even when whe reset the scrollbar position afterward this results in some
ungly flicker. so we do double buffering using "con1" and "con2". The always invisible "con0" is just a spacer
for positioning the input field correcly. -->
<textarea id="con1" rows="24" cols="100" readonly="1" style="visibility: visible; position: absolute;"></textarea>
<textarea id="con2" rows="24" cols="100" readonly="1" style="visibility: hidden; position: absolute;"></textarea>
<textarea id="con0" rows="24" cols="100" readonly="1" style="visibility: hidden"></textarea></br>
<b>&gt;</b><input id="prompt" size="80" onkeyup="handleKey(event.keyCode)"/>

<script><!--

var fixN = 0;

var hist = new Array();
var hidx = 0;

var env = {
};
var builtins = {
	dot: NumJS.DOT,
	pow: NumJS.POW,
	inv: NumJS.INV,
	abs: NumJS.ABS,
	norm: NumJS.NORM,
	arg: NumJS.ARG,
	conj: NumJS.CONJ,
	transp: NumJS.TRANSP,
	exp: NumJS.EXP,
	log: NumJS.LOG,
	det: NumJS.DET,
	re: NumJS.RE,
	im: NumJS.IM,
	round: NumJS.ROUND,
	PI: Math.PI,
	E: Math.E,
};

var conText = "";
var conActive = 1;

var welcomeMsg = "Type `example' to execute example session or `help' for command overview.";

function consoleOut(text)
{
	var conOff = document.getElementById("con" + conActive);
	conActive = conActive == 1 ? 2 : 1;
	var conOn = document.getElementById("con" + conActive);

	conText += text;
	conOn.value = conText;
	conOn.scrollTop = conOn.scrollHeight;
	conOn.style.visibility = "visible";
	conOff.style.visibility = "hidden";
}

function val2str(value)
{
	if (fixN > 0 && typeof(value.toFixed) == "function")
		return value.toFixed(fixN);
	if (typeof(value.toString) == "function")
		return value.toString();
	return value;
}

function exec(code)
{
	function myEval(code) {
		with (builtins) with (env)
			return eval(code);
	}

	code = code.replace(/^ */, "");

	if (code.search(/^debug (.*)/) == 0) {
		return NumJS.Parse(RegExp.$1);
	}

	if (code.search(/^example *$/) == 0) {
		consoleOut("\n");
		handleExec("prec 2");
		handleExec("A: [ 1, 2, 3; 4i, 5, 6i; -7, 9+9i, 0 ]");
		handleExec("y: [ 10; 20; 30 ]");
		handleExec("x: A \\ y");
		handleExec("A * x");
		return "END OF EXAMPLE";
	}

	if (code.search(/^help *$/) == 0) {
		var text = "\n";
		text += "     example ..................... execute example session\n";
		text += "     help ........................ this help message\n";
		text += "     list ........................ list variables and functions\n";
		text += "     expr   ...................... execute expression\n";
		text += "     var: expr   ................. define variable\n";
		text += "     func(args): expr   .......... define function\n";
		text += "     debug expr   ................ show javascript for expression\n";
		text += "     show expr   ................. display matrix in 2d format\n";
		text += "     prec N   .................... set display precision to N decimals\n";
		text += "     clear ....................... clear screen\n\n";
		text += "     Builtin functions: dot pow inv abs norm arg conj\n";
		text += "                        transp exp log det re im round\n\n";
		text += "     Builtin constants: PI E\n\n";
		text += "     Operators: ( ) * / \\ + -";
		return text;
	}

	if (code.search(/^list *$/) == 0) {
		var text = "";
		for (i in env) {
			text += "  " + i;
		}
		if (text == "")
			text = "*empty*";
		return text;
	}

	if (code.search(/^prec ([0-9]+) *$/) == 0) {
		fixN = +RegExp.$1;
		if (fixN == 0)
			return "*full precision*";
		return (0).toFixed(fixN);
	}

	if (code.search(/^clear *$/) == 0) {
		conText = "";
		return welcomeMsg;;
	}

	if (code.search(/^([A-Za-z][A-Za-z_0-9]*) *:(.*)/) == 0) {
		var name = RegExp.$1;
		var value = (myEval(NumJS.Parse(RegExp.$2)))();
		env[name] = value;
		return val2str(value);
	}

	if (code.search(/^([A-Za-z][A-Za-z_0-9]*) *\(([^()]*)\):(.*)/) == 0) {
		var msg = RegExp.$1 + "(" + RegExp.$2 + ")";
		var name = RegExp.$1;
		var value = myEval(NumJS.Parse(RegExp.$3, RegExp.$2));
		env[name] = value;
		return msg.replace(/ /g, "");
	}

	if (code.search(/^show (.*)/) == 0) {
		var value = (myEval(NumJS.Parse(RegExp.$1)))();
		if ("rows" in value && "cols" in value) {
			var text = "";
			var cellData = new Object();
			var maxlen = 0;
			for (var i = 0; i < value.rows; i++)
			for (var j = 0; j < value.cols; j++) {
				var v = val2str(value.get(i, j));
				if (v.length > maxlen)
					maxlen = v.length;
				cellData[i + " " + j] = v;
			}
			for (var i = 0; i < value.rows; i++)
			for (var j = 0; j < value.cols; j++) {
				var t = cellData[i + " " + j];
				while (t.length < maxlen)
					t = " " + t;
				text += "    " + t;
				if (j == value.cols-1 && i != value.rows-1)
					text += "\n";
			}
			return text;
		}
		return val2str(value);
	}

	var value = (myEval(NumJS.Parse(code)))();
	return val2str(value);
}

function handleExec(code)
{
	consoleOut("> " + code + "\n");
	hist.push(code);
	hidx = hist.length;

	try {
		var result = exec(code);
		consoleOut(result + "\n\n");
	} catch (err) {
		consoleOut(err + "\n\n");
	}
}

function handleKey(keyCode)
{
	if (keyCode == 13) {
		var code = document.getElementById("prompt").value;
		document.getElementById("prompt").value = "";
		handleExec(code);
	}
	if (keyCode == 38 && hidx > 0) {
		document.getElementById("prompt").value = hist[--hidx];
	}
	if (keyCode == 40 && hidx < hist.length) {
		if (++hidx == hist.length)
			document.getElementById("prompt").value = "";
		else
			document.getElementById("prompt").value = hist[hidx];
	}
}

consoleOut(welcomeMsg + "\n\n");
document.getElementById("prompt").value = "";
document.getElementById("prompt").focus();

//--></script>
